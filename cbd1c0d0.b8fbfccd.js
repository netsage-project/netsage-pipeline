(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{105:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return s})),a.d(t,"default",(function(){return d}));var o=a(2),n=a(6),r=(a(0),a(119)),l={id:"docker_install_advanced",title:"Docker Advanced Installation Guide",sidebar_label:"Docker Advanced"},i={unversionedId:"deploy/docker_install_advanced",id:"deploy/docker_install_advanced",isDocsHomePage:!1,title:"Docker Advanced Installation Guide",description:"If the Docker Simple installation does not meet your needs, the following customizations will allow for more complex situations.",source:"@site/docs/deploy/docker_install_advanced.md",slug:"/deploy/docker_install_advanced",permalink:"/netsage-pipeline/docs/next/deploy/docker_install_advanced",editUrl:"https://github.com/netsage-project/netsage-pipeline/edit/master/website/docs/deploy/docker_install_advanced.md",version:"current",sidebar_label:"Docker Advanced",sidebar:"Pipeline",previous:{title:"Docker Default Installation Guide",permalink:"/netsage-pipeline/docs/next/deploy/docker_install_simple"},next:{title:"Docker Troubleshooting",permalink:"/netsage-pipeline/docs/next/deploy/docker_troubleshoot"}},s=[{value:"To Add an Additional Sflow or Netflow Collector",id:"to-add-an-additional-sflow-or-netflow-collector",children:[{value:"1. Edit docker-compose.override.yml",id:"1-edit-docker-composeoverrideyml",children:[]},{value:"2.  Edit netsage_override.xml",id:"2--edit-netsage_overridexml",children:[]},{value:"3. Edit environment file",id:"3-edit-environment-file",children:[]},{value:"Running the new collector",id:"running-the-new-collector",children:[]}]},{value:"To Change the Culling of Nfcapd Files",id:"to-change-the-culling-of-nfcapd-files",children:[]},{value:"For Tstat Data",id:"for-tstat-data",children:[]},{value:"To Customize Java Settings / Increase Memory Available for Lostash",id:"to-customize-java-settings--increase-memory-available-for-lostash",children:[]},{value:"To Bring up Kibana and Elasticsearch Containers",id:"to-bring-up-kibana-and-elasticsearch-containers",children:[]},{value:"For Data Saved to an NFS Volume",id:"for-data-saved-to-an-nfs-volume",children:[]}],c={rightToc:s};function d(e){var t=e.components,a=Object(n.a)(e,["components"]);return Object(r.b)("wrapper",Object(o.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"If the Docker Simple installation does not meet your needs, the following customizations will allow for more complex situations."),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Please first read the Docker Simple installation guide in detail. This guide will build on top of that.")),Object(r.b)("h2",{id:"to-add-an-additional-sflow-or-netflow-collector"},"To Add an Additional Sflow or Netflow Collector"),Object(r.b)("p",null,"If you have more than 1 sflow and/or 1 netflow sensor, you will need to create more collectors and modify the importer config file. The following instructions describe the steps needed to add one additional sensor."),Object(r.b)("p",null,"Any number of sensors can be accomodated, although if there are more than a few being processed by the same Importer, you may run into issues where long-lasting flows from sensosr A time out in the aggregation step while waiting for flows from sensors B to D to be processed. (Another option might be be to run more than one Docker deployment.) "),Object(r.b)("h3",{id:"1-edit-docker-composeoverrideyml"},"1. Edit docker-compose.override.yml"),Object(r.b)("p",null,"The pattern to add a flow collector is always the same. To add an sflow collector called example-collector, edit the docker-compose.override.yml file and add"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),'  example-collector:\n    image: netsage/nfdump-collector:1.6.18\n    restart: always\n    command: sfcapd -T all -l /data -S 1 -w -z -p 9997\n    volumes:\n      - ./data/input_data/example:/data\n    ports:\n      - "9997:9997/udp"\n')),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},'collector-name: should be updated to something that has some meaning, in our example "example-collector".'),Object(r.b)("li",{parentName:"ul"},"command: choose between sfcapd for sflow and nfcapd for netflow, and at the end of the command, specify the port to watch for incoming flow data.  (Unless your flow exporter is already set up to use a different port, you can use the default ports and configure the exporters on the routers to match.)"),Object(r.b)("li",{parentName:"ul"},"ports: make sure the port here matches the port you've set in the command. Naturally all ports have to be unique for this host and the\nrouter should be configured to export data to the same port. (If the port on your docker container is different than the port on your host/local machine, use container_port:host_port.) "),Object(r.b)("li",{parentName:"ul"},"volumes: specify where to write the nfcapd files. Make sure the path is unique and in ./data/. In this case, we're writing to ./data/input_data/example. Change the last part of the path to something meaningful.")),Object(r.b)("p",null,"You will also need to uncomment these lines: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"  volumes:\n     - ./userConfig/netsage_override.xml:/etc/grnoc/netsage/deidentifier/netsage_shared.xml\n")),Object(r.b)("h3",{id:"2--edit-netsage_overridexml"},"2.  Edit netsage_override.xml"),Object(r.b)("p",null,"To make the Pipeline Importer aware of the new data to process, you will need to create a custom Importer configuration: netsage_override.xml.  This will replace the usual config file netsage_shared.xml. "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-sh"}),"cp compose/importer/netsage_shared.xml userConfig/netsage_override.xml\n")),Object(r.b)("p",null,'Edit netsage_override.xml and add a "collection" section for the new sensor as in the following example. The flow-path should match the path set above in docker-compose.override.yml. $exampleSensorName is a new "variable"; it will be replaced with a value set in the .env file. For the flow-type, enter "sflow" or "netflow" as appropriate.'),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-xml"}),"    <collection>\n        <flow-path>/data/input_data/example/</flow-path>\n        <sensor>$exampleSensorName</sensor>\n        <flow-type>sflow</flow-type>\n    </collection>\n")),Object(r.b)("h3",{id:"3-edit-environment-file"},"3. Edit environment file"),Object(r.b)("p",null,'Then, in the .env file, add a line that sets a value for the "variable" you referenced above, $exampleSensorName. The value is the name of the sensor which will be saved to elasticsearch and which appears in Netsage Dashboards. Set it to something meaningful and unique.'),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-ini"}),"exampleSensorName=Example New York sFlow\n")),Object(r.b)("h3",{id:"running-the-new-collector"},"Running the new collector"),Object(r.b)("p",null,"After doing the setup above and selecting the docker version to run, you can start the new collector by running the following line, using the collector name (or by running ",Object(r.b)("inlineCode",{parentName:"p"},"docker-compose up -d")," to start up all containers):"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-sh"}),"docker-compose up -d example-collector\n")),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"The default version of the collector is 1.6.18. There are other versions released and :latest should be point to the latest one, but there is no particular effort made to make sure we released the latest version. You can get a listing of all the current tags listed ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://hub.docker.com/r/netsage/nfdump-collector/tags"}),"here")," and the source to generate the docker image can be found ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/netsage-project/docker-nfdump-collector"}),"here")," the code for the You may use a different version though there is no particular effort to have an image for every nfdump release."))),Object(r.b)("h2",{id:"to-change-the-culling-of-nfcapd-files"},"To Change the Culling of Nfcapd Files"),Object(r.b)("p",null,"The importer will automatically delete older nfcapd files for you, so that your disk don't fill up. By default, 3 days worth of files will be kept. This can be adjusted by making a netsage_override.xml file:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-sh"}),"cp compose/importer/netsage_shared.xml userConfig/netsage_override.xml\n")),Object(r.b)("p",null,"At the bottom of the file, edit this section. Set cull-enable to 0 for no culling. Eg, to save 7 days worth of data:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-xml"}),"  <worker>\n    <cull-enable>1</cull-enable>\n    <cull-ttl>7</cull-ttl>\n  </worker>\n")),Object(r.b)("p",null,"You will also need to uncomment these lines in docker-compose.override.yml: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"  volumes:\n     - ./userConfig/netsage_override.xml:/etc/grnoc/netsage/deidentifier/netsage_shared.xml\n")),Object(r.b)("h2",{id:"for-tstat-data"},"For Tstat Data"),Object(r.b)("p",null,'Tstat data is not collected by nfdump/sfcapd/nfcapd or read by an Importer. Instead, the flow data is sent directly from the router or switch to the logstash pipeline\'s ingest rabbit queue (named "netsage_deidentifier_raw").  So, when following the Docker Simple guide, the sections related to configuring and starting up the collectors and Importer will not pertain to the tstat sensors. The .env file still needs to be set up though.'),Object(r.b)("p",null,"Setting up Tstat is outside the scope of this document, but see the Netsage project Tstat-Transport which contains client programs that can send tstat data to a rabbit queue. See ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/netsage-project/tstat-transport.git"}),"https://github.com/netsage-project/tstat-transport.git"),"."),Object(r.b)("h2",{id:"to-customize-java-settings--increase-memory-available-for-lostash"},"To Customize Java Settings / Increase Memory Available for Lostash"),Object(r.b)("p",null,"If you need to modify the amount of memory logstash can use or any other java settings,\nrename the provided example for JVM Options and tweak the settings as desired."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-sh"}),"cp userConfig/jvm.options_example userConfig/jvm.options\n")),Object(r.b)("p",null,"Also update the docker-compose.override.xml file to uncomment lines in the logstash section. It should look something like this:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"logstash:\n  image: netsage/pipeline_logstash:latest\n  volumes:\n    - ./userConfig/jvm.options:/usr/share/logstash/config/jvm.options\n")),Object(r.b)("h2",{id:"to-bring-up-kibana-and-elasticsearch-containers"},"To Bring up Kibana and Elasticsearch Containers"),Object(r.b)("p",null,"The file docker-compose.develop.yaml can be used in conjunction with docker-compose.yaml to bring up the optional Kibana and Elastic Search components."),Object(r.b)("p",null,"This isn't a production pattern but the tools can be useful at times. Please refer to the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"../devel/docker_dev_guide#optional-elasticsearch-and-kibana"}),"Docker Dev Guide")),Object(r.b)("h2",{id:"for-data-saved-to-an-nfs-volume"},"For Data Saved to an NFS Volume"),Object(r.b)("p",null,"By default, data is saved to subdirectories in the ./data directory.  If you would like to use an NFS mount instead you will need to either"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"export the NFS volume as ${PROJECT_DIR}/data (which is the idea scenario and least intrusive)"),Object(r.b)("li",{parentName:"ol"},"update the path to the NFS export path in all locations in docker-compose.yml and docker-compose.override.yml")),Object(r.b)("p",null,"Note: modifying all the paths in the two files should work, but may not. In one case, it worked to modify only the paths for the collector volumes (eg, - /mnt/nfs/netsagedata/netflow:/data), leaving all others with their default values."),Object(r.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(r.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"If you choose to update the docker-compose file, keep in mind that those changes will cause a merge conflict on upgrade.\nYou'll have to manage the volumes exported and ensure all the paths are updated correctly for the next release manually."))))}d.isMDXComponent=!0},119:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return h}));var o=a(0),n=a.n(o);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var c=n.a.createContext({}),d=function(e){var t=n.a.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=d(e.components);return n.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},m=n.a.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=d(a),m=o,h=p["".concat(l,".").concat(m)]||p[m]||u[m]||r;return a?n.a.createElement(h,i(i({ref:t},c),{},{components:a})):n.a.createElement(h,i({ref:t},c))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var c=2;c<r;c++)l[c]=a[c];return n.a.createElement.apply(null,l)}return n.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);