version: "3.7"

# Default docker services and settings. 
# Do not make changes here; use the override file.

# Shared network for the containers. They will be able to communicate over default ports.
networks:
    netsage-network:

services:
  sfacctd_1:
    container_name: sfacctd_1
    image: pmacct/sfacctd:v1.7.9
    env_file: .env
    ports:
      # port on host for incoming flow data : port in the container
      - "6343:8000/udp"
    volumes:
      # location of our configs : default location : read-only
      - ./conf-pmacct:/etc/pmacct:ro
    command:
      # override the default parameters (entrypoint is the actual command)
      - -f 
      - /etc/pmacct/sfacctd_1.conf
    networks:
      - netsage-network
    depends_on:
      - rabbit

  sfacctd_2:
    container_name: sfacctd_2
    image: pmacct/sfacctd:v1.7.9
    env_file: .env
    ports:
      # port on host for incoming flow data : port in the container
      - "9999:8000/udp"
    volumes:
      # location of our configs : default location : read-only
      - ./conf-pmacct:/etc/pmacct:ro
    command:
      # override the default parameters (entrypoint is the actual command)
      - -f
      - /etc/pmacct/sfacctd_2.conf
    networks:
      - netsage-network
    depends_on:
      - rabbit
 
  nfacctd_1:
    container_name: nfacctd_1
    image: pmacct/nfacctd:v1.7.9
    env_file: .env
    ports:
      # port on host for incoming flow data : port in the container
      - "9998:9000/udp"
    volumes:
      # location of our configs : default location : read-only
      - ./conf-pmacct:/etc/pmacct:ro
    command:
      # override the default parameters (entrypoint is the actual command)
      - -f 
      - /etc/pmacct/nfacctd_1.conf
    networks:
      - netsage-network
    depends_on:
      - rabbit
 
  rabbit:
    container_name: rabbit
    hostname: rabbit
    image: rabbitmq:4.0-management
    env_file: .env
    ports:
      # The port for the UI needs to be mapped to that on the host
      # To view, go to https://<host>/rabbit
      - "15672:15672"
    volumes:
      # Use a named Volume for the rabbitmq config and files for its own use. 
      # We want data (msgs in the queue) to persist but don't need to see it.
      - rabbit_vol:/var/lib/rabbitmq
    networks: 
      - netsage-network

  logstash:
    container_name: logstash
    image: logstash:8.12.2
    env_file: .env
    # user uid
    user: 1000:1000
    # Explicitly specify *.conf to be sure logstash doesn't use *.disabled configs. 
    command: logstash -f /etc/logstash/conf.d/*.conf
    volumes:
      # location of logstash configs on host : location within container : read-only
      - ./conf-logstash/:/etc/logstash/conf.d/:ro
      # location of downloaded maxmind and caida files on host : location within container : read-only 
      - ./logstash-downloads/:/var/lib/netsage/:ro  
      # location for aggregation map files, which save flows being aggregated when logstash shuts down
      - ./logstash-temp/:/logstash-temp/
    networks: 
      - netsage-network
    depends_on:
      - rabbit
    # restart is not included since if logstash dies, there may be an error and we dont' want it to keep restarting over and over
  
# named volumes 
volumes:
    rabbit_vol:

