(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{209:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var o=n(0),a=n.n(o);function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},c=Object.keys(e);for(o=0;o<c.length;o++)n=c[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(o=0;o<c.length;o++)n=c[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var d=a.a.createContext({}),l=function(e){var t=a.a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.a.createElement(d.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},b=a.a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,c=e.originalType,r=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=l(n),b=o,m=u["".concat(r,".").concat(b)]||u[b]||p[b]||c;return n?a.a.createElement(m,i(i({ref:t},d),{},{components:n})):a.a.createElement(m,i({ref:t},d))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var c=n.length,r=new Array(c);r[0]=b;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,r[1]=i;for(var d=2;d<c;d++)r[d]=n[d];return a.a.createElement.apply(null,r)}return a.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},87:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return l}));var o=n(3),a=n(7),c=(n(0),n(209)),r={id:"docker_dev_guide",title:"Docker Dev Guide",sidebar_label:"Docker Dev Guide"},i={unversionedId:"devel/docker_dev_guide",id:"devel/docker_dev_guide",isDocsHomePage:!1,title:"Docker Dev Guide",description:"Handy Docker Commands",source:"@site/docs/devel/docker.md",slug:"/devel/docker_dev_guide",permalink:"/netsage-pipeline/docs/next/devel/docker_dev_guide",editUrl:"https://github.com/netsage-project/netsage-pipeline/edit/master/website/docs/devel/docker.md",version:"current",sidebar_label:"Docker Dev Guide",sidebar:"Pipeline",previous:{title:"Pipeline Replay Dataset",permalink:"/netsage-pipeline/docs/next/devel/dev_dataset"},next:{title:"Revising Documentation",permalink:"/netsage-pipeline/docs/next/devel/docusaurus"}},s=[{value:"Handy Docker Commands",id:"handy-docker-commands",children:[{value:"Start the Containers",id:"start-the-containers",children:[]},{value:"Stop the Containers",id:"stop-the-containers",children:[]},{value:"Enter a Container Shell",id:"enter-a-container-shell",children:[]},{value:"View Container Logs",id:"view-container-logs",children:[]}]},{value:"To Build Docker Images",id:"to-build-docker-images",children:[]},{value:"To push images to the GitHub Container Registry",id:"to-push-images-to-the-github-container-registry",children:[]},{value:"Run ElasticSearch and Kibana Containers",id:"run-elasticsearch-and-kibana-containers",children:[]}],d={toc:s};function l(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(c.b)("wrapper",Object(o.a)({},d,n,{components:t,mdxType:"MDXLayout"}),Object(c.b)("h2",{id:"handy-docker-commands"},"Handy Docker Commands"),Object(c.b)("h3",{id:"start-the-containers"},"Start the Containers"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-sh"},"docker-compose up -d \n")),Object(c.b)("h3",{id:"stop-the-containers"},"Stop the Containers"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-sh"},"docker-compose down\ndocker-compose stop && docker-compose rm \n")),Object(c.b)("h3",{id:"enter-a-container-shell"},"Enter a Container Shell"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-sh"},"docker-compose exec logstash bash     # run bash shell in logstash container\n")),Object(c.b)("h3",{id:"view-container-logs"},"View Container Logs"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-sh"},"docker-compose logs -f              # view logs for all containers \ndocker-compose logs -f <container>  # view logs for container, eg logstash\n")),Object(c.b)("h2",{id:"to-build-docker-images"},"To Build Docker Images"),Object(c.b)("p",null,"We will normally use official images for rabbitMQ, logstash, nfacctd, and sfacctd, so no building of images is required."),Object(c.b)("p",null,"However, in case there is not an offical image of nfacctd or sfacctd that includes required commits, you may need to build images from master."),Object(c.b)("p",null,"Below are the steps used to build the pmacct Docker images for v2.0. In the future, you may not have to apply a patch. (Without the patch, when bringing up the nfacctd or sfacctd container, we got ",Object(c.b)("em",{parentName:"p"},"error while loading shared libraries: libndpi.so.4: cannot open shared object file: No such file or directory"),".)"),Object(c.b)("p",null,"You may need to first add dns servers from /etc/resolv.conf to /etc/docker/daemon.json and restart docker."),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"$ git clone https://github.com/pmacct/pmacct.git\n$ mv pmacct pmacct-30June2022+patch\n$ cd pmacct-30June2022/\n$ git checkout 865a81e1f6c444aab32110a87d72005145fd6f74\n$ git submodule update --init --recursive\n$ git am -3 0001-ci-docker-fix-docker-multi-stage-build.patch\n$ sudo docker build -f docker/base/Dockerfile -t pmacct:base .\n$ sudo docker tag  pmacct:base  base:_build\n$ sudo docker build -f docker/nfacctd/Dockerfile -t nfacctd:7Jun2022 .\n$ sudo docker build -f docker/nfacctd/Dockerfile -t sfacctd:7Jun2022 .  \n\n$ sudo docker-compose up -d\n$ sudo docker-cmopose down\n")),Object(c.b)("p",null,"These steps clone pmacct, change the name of the directory, checkout the code from the desired point in time, get files for submodules, apply the patch that was emailed and saved to ~/lensman/GIT/pmacct-30June2022+patch/0001-ci-docker-fix-docker-multi-stage-build.patch on netsage-pipeline-dev2.bldc, build the base image, rename the base image, build nfacctd and sfacctd images. After building, do a test run (of course, first make the .env file, etc.). When ready, push to the Github Container Registry."),Object(c.b)("p",null,"The nfacctd and sfacctd images are just the base image plus specific commands to run. "),Object(c.b)("h2",{id:"to-push-images-to-the-github-container-registry"},"To push images to the GitHub Container Registry"),Object(c.b)("p",null,"You need to have a personal access token and (presumably) be part of the Netsage Project. The personal access token needs at least the following scopes:  repo, read/write/delete:packages. "),Object(c.b)("p",null,"As an example, here is how lisaens pushed the images for 2.0:"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"$ sudo docker login ghcr.io -u lisaens \n$ sudo docker images \n    REPOSITORY            TAG              IMAGE ID       CREATED        SIZE\n    sfacctd               7Jun2022         f62b1c6cddbd   5 weeks ago    346MB\n    nfacctd               7Jun2022         5833977f6dd0   5 weeks ago    346MB\n    ...\n$ sudo docker tag f62b1c6cddbd ghcr.io/netsage-project/sfacctd:7Jun2022\n$ sudo docker push ghcr.io/netsage-project/sfacctd:7Jun2022\n$ sudo docker tag 5833977f6dd0 ghcr.io/netsage-project/nfacctd:7Jun2022\n$ sudo docker push ghcr.io/netsage-project/nfacctd:7Jun2022\n\nGo to the Netsage Project in github (netsage-project), click on Packages, click on an image, \nclick on Connect to Repository and select Netsage Pipeline, then go to\xa0Package Settings \n(lower right). In the\xa0Danger Zone, click on\xa0Change Visibility\xa0and choose\xa0Public.\n")),Object(c.b)("p",null,"NOTE that the docker-compose.yml file must refer to the images using the registry location, eg, for sfacctd  ",Object(c.b)("inlineCode",{parentName:"p"},"ghcr.io/netsage-project/sfacctd:7jun2022"),"."),Object(c.b)("h2",{id:"run-elasticsearch-and-kibana-containers"},"Run ElasticSearch and Kibana Containers"),Object(c.b)("p",null,"You can optionally store flow data locally in an ElasticSearch container and view the data with Kibana. Local storage can be enabled with the following steps:"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"Uncomment the following lines in conf-logstash/99-outputs.conf:")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'elasticsearch {\n    hosts => ["elasticsearch"]\n    index => "netsage_flow-%{+YYYY.MM.dd}"\n}\n')),Object(c.b)("ol",{start:2},Object(c.b)("li",{parentName:"ol"},Object(c.b)("p",{parentName:"li"},"Comment out the ",Object(c.b)("inlineCode",{parentName:"p"},"rabbitmq {...}")," block in conf-logstash/99-outputs.conf if you do not want to also send logstash output to RabbitMQ.")),Object(c.b)("li",{parentName:"ol"},Object(c.b)("p",{parentName:"li"},"Run the containers using the following line: ",Object(c.b)("inlineCode",{parentName:"p"}," "),"  ",Object(c.b)("inlineCode",{parentName:"p"},"docker-compose -f docker-compose.yml  -f docker-compose.develop.yml up  -d"),"  ",Object(c.b)("inlineCode",{parentName:"p"}," ")))))}l.isMDXComponent=!0}}]);