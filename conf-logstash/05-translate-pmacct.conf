# Translate pmacct fields to those the rest of the pipeline uses
       # NOTE: pmacct (nfacctd and sfacctd) must be run with
       # pretag files wherein 'label' must be set to 'sfacct--' or 'nfacct--'
       # followed by the sensor name with spaces replaced by #s.

filter {
 # skip all this for tstat!
 if [label] {

    # FOF SFLOW -
    if [label] =~ /^sfacct--/ {
        mutate {
            add_field => { "[meta][flow_type]" => "sflow" }
            # Assuming some aggregation over time by sfacctd:
            rename => {'timestamp_min' => 'start'}
            rename => {'timestamp_max' => 'end'}
            id => "05-1"
        }
    }

    # FOR NETFLOW -
    if [label] =~ /^nfacct--/ {
        mutate {
            add_field => { "[meta][flow_type]" => "netflow" }
            # Assuming no aggregation over time by nfacctd:
            rename => {'timestamp_start' => 'start'}
            rename => {'timestamp_end'   => 'end'}
            id => "05-2"
        }
    }

   # FOR ALL PMACCT FLOWS -
   # Tag flows without a sampling rate 
   # (router may not be sending it, template may not have arrived yet, there may be no sampling)
   # Here sampling_rate is just a flag, 0 or 1. Save the flag to @sampling_corrected.
   if [sampling_rate] == 0 {
       mutate {
           id => "05-3"
           add_tag => ["No sampling rate found on ingest"]
           add_field =>  { "@sampling_corrected" => [sampling_rate] }
       }
   }
   # Get sensor name
   # Note: In the pmacct pretag file, label must be set to sfacct-- or nfacct--
   # followed by the real sensor name with spaces replaced by #s.
    ruby {
        code => '
            sensor = event.get("label")
            sensor = sensor.gsub("sfacct--", "")
            sensor = sensor.gsub("nfacct--", "")
            sensor = sensor.gsub("#", " ")
            event.set( "[meta][sensor_id]", sensor )
        '
        tag_on_exception => '_rubyexception getting sensor from label in 05-translate-pmacct. '
        id => "05-4"
    }
    # Do field name translations
    mutate {
        rename => {'ip_src'    => '[meta][src_ip]'}
        rename => {'ip_dst'    => '[meta][dst_ip]'}
        rename => {'port_src'  => '[meta][src_port]'}
        rename => {'port_dst'  => '[meta][dst_port]'}
        rename => {'ip_proto'  => '[meta][protocol]'}
        rename => {'iface_in'  => '[meta][src_ifindex]'}
        rename => {'iface_out' => '[meta][dst_ifindex]'}
        rename => {'as_src'    => '[meta][src_asn]'}
        rename => {'as_dst'    => '[meta][dst_asn]'}
        rename => {'packets'   => '[values][num_packets]'}
        id => "05-5"
    }
    # Start and end are timestamps at this point. Make sure they are floats.
    mutate {
      convert => {
        'start'  => 'float'
        'end'    => 'float'
      }
      id => "05-6"
    }
    # Calculations
    ruby {
        code => '
            event.set( "[values][num_bits]", event.get("bytes") * 8 )
            event.set( "[values][duration]", event.get("end") - event.get("start") )
            if event.get("[values][duration]") <= 0.001    ## == 0 to within roundoff error
                event.set( "[values][bits_per_second]",    0.0 )
                event.set( "[values][packets_per_second]", 0.0 )
            else
                bps = event.get("[values][num_bits]")    / event.get("[values][duration]")
                pps = event.get("[values][num_packets]") / event.get("[values][duration]")
                event.set( "[values][bits_per_second]" ,   bps )
                event.set( "[values][packets_per_second]", pps )
            end
        '
        tag_on_exception => '_rubyexception in 05-translate-pmacct. '
        id => "05-7"
    }
    # Make sure these are numeric types. We need to use them in calculations and comparisons later.
    mutate {
      convert => {
        '[values][num_bits]'           => 'integer'
        '[values][num_packets]'        => 'integer'
        '[values][duration]'           => 'float'
        '[values][bits_per_second]'    => 'float'
        '[values][packets_per_second]' => 'float'
        '[meta][src_port]'             => 'integer'
        '[meta][dst_port]'             => 'integer'
      }
      id => "05-8"
    }
    # Remove unneeded fields
    mutate {
        remove_field => [ 'sampling_rate', 'event_type', 'writer_id' ]
        remove_field => [ 'label',         'bytes' ]
        id => "05-9"
    }

  }
}
